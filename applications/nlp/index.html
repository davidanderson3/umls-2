<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>MetaMapLite Demo</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 2em;
        }

        textarea,
        input[type=text] {
            width: 100%;
            box-sizing: border-box;
        }

        label {
            display: block;
            margin: .5em 0 .2em;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 0.3em;
            text-align: left;
        }

        th {
            background: #eee;
        }

        #output {
            margin-top: 1em;
        }
    </style>
</head>

<body>
    <h1>MetaMapLite Demo</h1>
        <form id="mm-form">
            <label for="input">Clinical Text:</label>
            <textarea id="input" name="text" placeholder="Enter your sentence…"></textarea>
            <label><input type="checkbox" id="debug" name="debug"> Debug</label>

        <!-- Simple run without restriction parameters -->


        <button type="submit">Annotate</button>
    </form>

    <div id="output">
        <!-- populated by JS -->
    </div>

    <script>
        const form = document.getElementById('mm-form');
        const output = document.getElementById('output');

        form.addEventListener('submit', async e => {
            e.preventDefault();
            output.innerHTML = '<p>Processing…</p>';

            // collect form data
            const data = new URLSearchParams(new FormData(form));
            const debug = document.getElementById('debug').checked;

            try {
                const res = await fetch('/cgi-bin/metamaplite.cgi' + (debug ? '?debug=1' : ''), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: data.toString()
                });
                if (!res.ok) throw new Error(res.statusText);
                if (debug) {
                    const text = await res.text();
                    output.innerHTML = '';
                    const pre = document.createElement('pre');
                    pre.textContent = text;
                    output.appendChild(pre);

                    let idx = Math.max(text.lastIndexOf('['), text.lastIndexOf('{'));
                    if (idx !== -1) {
                        try {
                            const json = JSON.parse(text.slice(idx));
                            const div = document.createElement('div');
                            div.innerHTML = createResultsTable(json);
                            output.appendChild(div);
                        } catch (_) {
                            /* ignore parse errors */
                        }
                    }
                } else {
                    const json = await res.json();
                    renderResults(json);
                }
            } catch (err) {
                output.innerHTML = `<p style="color:red">Error: ${err.message}</p>`;
            }
        });

        function createResultsTable(data) {
            let anns;
            if (Array.isArray(data)) {
                anns = data.map(ent => {
                    const ev = (ent.evlist && ent.evlist[0]) || {};
                    const ci = ev.conceptinfo || {};
                    return {
                        trigger: ent.matchedtext || '',
                        cui: ci.cui || '',
                        preferredName: ci.preferredname || '',
                        semanticTypes: ci.semantictypes || [],
                        score: ev.score,
                        span: (ent.start != null && ent.length != null)
                            ? { begin: ent.start, end: ent.start + ent.length }
                            : null
                    };
                });
            } else {
                anns = data.annotations || [];
            }
            if (!anns || anns.length === 0) {
                return '<p><em>No entities found.</em></p>';
            }
            let html = `
      <table>
        <thead>
          <tr>
            <th>Text</th>
            <th>CUI</th>
            <th>Name</th>
            <th>Type(s)</th>
            <th>Score</th>
            <th>Span</th>
          </tr>
        </thead>
        <tbody>
        `;
            anns.forEach(ent => {
                const txt = ent.trigger || '';
                const cui = ent.cui || '';
                const name = ent.preferredName || '';
                const types = (ent.semanticTypes || []).join(', ');
                const score = ent.score != null ? ent.score : '';
                const span = ent.span ? `${ent.span.begin}-${ent.span.end}` : '';
                html += `
        <tr>
          <td>${txt}</td>
          <td>${cui}</td>
          <td>${name}</td>
          <td>${types}</td>
          <td>${score}</td>
          <td>${span}</td>
        </tr>
        `;
            });
            html += `</tbody></table>`;
            return html;
        }

        function renderResults(json) {
            output.innerHTML = createResultsTable(json);
        }
    </script>
</body>

</html>